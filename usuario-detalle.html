<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MACRO GYM - Detalle de Usuario</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="acceso-styles.css">
</head>
<body>
    <!-- Botón para volver arriba -->
    <button id="back-to-top" class="back-to-top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <header>
        <nav class="navbar">
            <div class="navbar-container">
                <div class="logo">
                    <a href="Index.html">
                        <img src="img/logo.png" alt="Logo MacroGym Fitness">
                    </a>
                </div>
                
                <div class="menu-toggle" id="mobile-menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="Index.html" class="nav-link">Inicio</a></li>
                    <li class="nav-item"><a href="acceso-gym.html" class="nav-link">Control de Acceso</a></li>
                    <li class="nav-item"><a href="admin.html" class="nav-link">Administración</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="access-section">
            <div class="access-container">
                <div class="access-header">
                    <h2>DETALLE DE USUARIO</h2>
                    <div class="section-divider">
                        <span></span>
                        <i class="fas fa-user-chart"></i>
                        <span></span>
                    </div>
                    <p>Estadísticas mensuales de asistencia al gimnasio</p>
                </div>
                
                <div class="user-info-card visible">
                    <div class="user-header" id="userHeader">
                        <!-- Información del usuario se cargará aquí -->
                    </div>
                    
                    <div class="membership-status" id="membershipStatus">
                        <!-- Estado de membresía se cargará aquí -->
                    </div>
                </div>
                
                <div class="monthly-stats-container">
                    <div class="monthly-stats-header">
                        <h3>Estadísticas por Mes</h3>
                    </div>
                    
                    <div class="month-tabs" id="monthTabs">
                        <!-- Las pestañas de meses se generarán dinámicamente -->
                    </div>
                    
                    <div id="monthContents">
                        <!-- El contenido de cada mes se generará dinámicamente -->
                    </div>
                </div>
                
                <div class="view-details-container">
                    <a href="acceso-gym.html" class="view-details-button">
                        <i class="fas fa-arrow-left"></i>
                        Volver al Control de Acceso
                    </a>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-main">
            <div class="footer-content">
                <div class="footer-info">
                    <div class="footer-logo">
                        <img src="img/logo.png" alt="Logo MacroGym Fitness">
                    </div>
                    <p>MacroGym Fitness es tu mejor opción con equipos de última generación y entrenadores profesionales para ayudarte a alcanzar tus objetivos de entrenamiento.</p>
                </div>
                <div class="footer-links">
                    <h3>Enlaces Rápidos</h3>
                    <ul>
                        <li><a href="Index.html">Inicio</a></li>
                        <li><a href="inscripcion.html">Registro</a></li>
                        <li><a href="Index.html#contacto">Consulta</a></li>
                        <li><a href="fitness-wiki.html">Fitness Wiki</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h3>Información de Contacto</h3>
                    <div class="footer-contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>Av. Francisco Acuña De Figueroa casi, Asunción 001102</p>
                    </div>
                    <div class="footer-contact-item">
                        <i class="fas fa-phone"></i>
                        <p>+595 991 765 892</p>
                    </div>
                    <div class="footer-contact-item">
                        <i class="fas fa-envelope"></i>
                        <p>info@macrogym.com</p>
                    </div>
                </div>
                <div class="footer-newsletter">
                    <h3>Suscripción al boletín informativo</h3>
                    <p>Recibe noticias, promociones y consejos de fitness por correo electrónico.</p>
                    <form class="newsletter-form">
                        <input type="email" placeholder="Correo Electronico">
                        <button type="submit"><i class="fas fa-arrow-right"></i></button>
                    </form>
                </div>
            </div>
            <div class="footer-social">
                <a href="https://www.facebook.com/macrogympy/?locale=es_LA" target="_blank" class="social-icon">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://www.instagram.com/macrogymfitness/" target="_blank" class="social-icon">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://api.whatsapp.com/send?phone=%2B595991765892" target="_blank" class="social-icon">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="#" target="_blank" class="social-icon">
                    <i class="fab fa-youtube"></i>
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p class="copyright">Copyright &copy; 2025 - MacroGym Fitness Todos los derechos reservados</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Menú móvil
            const mobileMenu = document.getElementById('mobile-menu');
            const navMenu = document.querySelector('.nav-menu');
            
            mobileMenu.addEventListener('click', function() {
                mobileMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
    
            // Cerrar menú al hacer clic en un enlace
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
    
            // Botón para volver arriba
            const backToTopButton = document.getElementById('back-to-top');
            
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            });
            
            backToTopButton.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // Obtener el parámetro de la URL (cédula del usuario)
            const urlParams = new URLSearchParams(window.location.search);
            const cedula = urlParams.get('cedula');
            
            if (!cedula) {
                alert('No se ha especificado un usuario');
                window.location.href = 'acceso-gym.html';
                return;
            }
            
            // Cargar datos del usuario
            loadUserData(cedula);
        });
        
        // Función para cargar los datos del usuario
        function loadUserData(cedula) {
            // Obtener datos del usuario
            const users = JSON.parse(localStorage.getItem('inscripcionData')) || [];
            const user = users.find(u => u.cedula === cedula);
            
            if (!user) {
                alert('Usuario no encontrado');
                window.location.href = 'acceso-gym.html';
                return;
            }
            
            // Obtener accesos del usuario
            const accesses = JSON.parse(localStorage.getItem('accessData')) || [];
            const userAccesses = accesses.filter(access => access.cedula === cedula);
            
            // Mostrar información del usuario
            displayUserInfo(user);
            
            // Mostrar estadísticas mensuales
            displayMonthlyStats(user, userAccesses);
        }
        
        // Función para mostrar información del usuario
        function displayUserInfo(user) {
            const userHeader = document.getElementById('userHeader');
            const membershipStatus = document.getElementById('membershipStatus');
            
            // Calcular días transcurridos desde la inscripción
            const registrationDate = new Date(user.fecha_inscripcion);
            const lastRenewalDate = user.ultima_renovacion ? new Date(user.ultima_renovacion) : registrationDate;
            const currentDate = new Date();
            
            // Calcular diferencia en días
            const diffTime = currentDate - lastRenewalDate;
            const daysSinceRegistration = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Calcular días restantes (de 30 días)
            const remainingDays = 30 - daysSinceRegistration;
            
            // Verificar si la membresía está activa
            const isActive = remainingDays > 0;
            
            // Determinar estado de la membresía
            let statusClass = 'active';
            let statusText = 'Activa';
            
            if (!isActive) {
                statusClass = 'expired';
                statusText = 'Vencida';
            } else if (remainingDays <= 5) {
                statusClass = 'expiring';
                statusText = 'Por vencer';
            }
            
            // Iniciales del usuario
            const userInitials = `${user.nombre.charAt(0)}${user.apellido.charAt(0)}`;
            
            // Actualizar UI
            userHeader.innerHTML = `
                <div class="user-avatar">${userInitials}</div>
                <div class="user-details">
                    <h3>${user.nombre} ${user.apellido}</h3>
                    <p>C.I.: ${user.cedula}</p>
                    <p>Plan: ${user.plan}</p>
                    <p>Horario: ${user.horario}</p>
                    <p>Fecha de inscripción: ${new Date(user.fecha_inscripcion).toLocaleDateString('es-ES')}</p>
                    <p>Días desde inscripción: ${daysSinceRegistration}</p>
                </div>
            `;
            
            membershipStatus.innerHTML = `
                <i class="fas fa-${statusClass === 'active' ? 'check-circle' : statusClass === 'expiring' ? 'exclamation-circle' : 'times-circle'}"></i>
                Membresía ${statusText} - ${statusClass === 'expired' ? 'Necesita renovar' : `${remainingDays} días restantes de 30`}
            `;
            
            membershipStatus.className = `membership-status ${statusClass}`;
        }
        
        // Función para mostrar estadísticas mensuales
        function displayMonthlyStats(user, accesses) {
            // Agrupar accesos por mes
            const monthlyAccesses = groupAccessesByMonth(accesses);
            
            // Si no hay accesos, mostrar mensaje
            if (Object.keys(monthlyAccesses).length === 0) {
                document.getElementById('monthTabs').innerHTML = '<div class="month-tab active">Sin datos</div>';
                document.getElementById('monthContents').innerHTML = '<div class="month-content active"><p>No hay registros de asistencia para este usuario.</p></div>';
                return;
            }
            
            // Generar pestañas de meses
            const monthTabs = document.getElementById('monthTabs');
            const monthContents = document.getElementById('monthContents');
            
            monthTabs.innerHTML = '';
            monthContents.innerHTML = '';
            
            // Ordenar meses (más recientes primero)
            const sortedMonths = Object.keys(monthlyAccesses).sort((a, b) => {
                const [monthA, yearA] = a.split('-');
                const [monthB, yearB] = b.split('-');
                
                if (yearA !== yearB) {
                    return yearB - yearA;
                }
                
                return monthB - monthA;
            });
            
            // Crear pestañas y contenido para cada mes
            sortedMonths.forEach((monthYear, index) => {
                const [month, year] = monthYear.split('-');
                const monthName = getMonthName(parseInt(month));
                const isActive = index === 0 ? 'active' : '';
                
                // Crear pestaña
                const tab = document.createElement('div');
                tab.className = `month-tab ${isActive}`;
                tab.textContent = `${monthName} ${year}`;
                tab.dataset.month = monthYear;
                tab.addEventListener('click', function() {
                    // Desactivar todas las pestañas y contenidos
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.month-content').forEach(c => c.classList.remove('active'));
                    
                    // Activar la pestaña y contenido seleccionados
                    this.classList.add('active');
                    document.querySelector(`.month-content[data-month="${this.dataset.month}"]`).classList.add('active');
                });
                
                monthTabs.appendChild(tab);
                
                // Crear contenido
                const content = document.createElement('div');
                content.className = `month-content ${isActive}`;
                content.dataset.month = monthYear;
                
                // Contar días únicos de asistencia
                const uniqueDays = new Set();
                monthlyAccesses[monthYear].forEach(access => {
                    const date = new Date(access.timestamp);
                    const dayString = date.toISOString().split('T')[0];
                    uniqueDays.add(dayString);
                });
                
                // Estadísticas del mes
                content.innerHTML = `
                    <div class="month-stats">
                        <div class="month-stat-item">
                            <div class="month-stat-value">${uniqueDays.size}</div>
                            <div class="month-stat-label">Días Asistidos</div>
                        </div>
                        <div class="month-stat-item">
                            <div class="month-stat-value">${getDaysInMonth(parseInt(month), parseInt(year))}</div>
                            <div class="month-stat-label">Días en el Mes</div>
                        </div>
                        <div class="month-stat-item">
                            <div class="month-stat-value">${Math.round((uniqueDays.size / getDaysInMonth(parseInt(month), parseInt(year))) * 100)}%</div>
                            <div class="month-stat-label">Asistencia</div>
                        </div>
                    </div>
                    <h4>Detalle de Asistencia</h4>
                    <div class="month-attendance-list">
                        ${generateAttendanceList(monthlyAccesses[monthYear])}
                    </div>
                `;
                
                monthContents.appendChild(content);
            });
        }
        
        // Función para agrupar accesos por mes
        function groupAccessesByMonth(accesses) {
            const monthlyAccesses = {};
            
            accesses.forEach(access => {
                const date = new Date(access.timestamp);
                const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
                
                if (!monthlyAccesses[monthYear]) {
                    monthlyAccesses[monthYear] = [];
                }
                
                monthlyAccesses[monthYear].push(access);
            });
            
            return monthlyAccesses;
        }
        
        // Función para generar lista de asistencia
        function generateAttendanceList(accesses) {
            // Ordenar accesos por fecha (más recientes primero)
            const sortedAccesses = [...accesses].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            // Agrupar por día
            const dailyAccesses = {};
            
            sortedAccesses.forEach(access => {
                const date = new Date(access.timestamp);
                const dayString = date.toISOString().split('T')[0];
                
                if (!dailyAccesses[dayString]) {
                    dailyAccesses[dayString] = [];
                }
                
                dailyAccesses[dayString].push(access);
            });
            
            // Generar HTML
            let html = '';
            
            for (const [day, dayAccesses] of Object.entries(dailyAccesses)) {
                const date = new Date(day);
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                html += `
                    <div class="history-item">
                        <div class="history-date">${formattedDate}</div>
                        <div class="history-time">
                            ${dayAccesses.map(access => {
                                const accessTime = new Date(access.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                                return `<span>${accessTime}</span>`;
                            }).join(', ')}
                        </div>
                    </div>
                `;
            }
            
            return html || '<p>No hay registros de asistencia para este mes.</p>';
        }
        
        // Función para obtener el nombre del mes
        function getMonthName(month) {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return monthNames[month - 1];
        }
        
        // Función para obtener el número de días en un mes
        function getDaysInMonth(month, year) {
            return new Date(year, month, 0).getDate();
        }
    </script>
</body>
</html>